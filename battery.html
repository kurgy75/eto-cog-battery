<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>ETO Battery — Corsi + Grid + Go/No-Go</title>
  <style>
    :root { --card:#fff; --border:#ddd; --txt:#111; --muted:#555; --ok:#0a7; --warn:#b60; --err:#c33; }
    body { font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial, sans-serif; margin:0; background:#fafafa; color:var(--txt); }
    .wrap { max-width: 980px; margin: 0 auto; padding: 18px; }
    .card { background: var(--card); border:1px solid var(--border); border-radius:16px; padding:16px; margin: 14px 0; box-shadow: 0 2px 10px rgba(0,0,0,.03); }
    .row { display:flex; gap:12px; flex-wrap:wrap; align-items:center; }
    label { display:flex; gap:6px; align-items:center; flex-wrap:wrap; }
    input, select { padding:10px 10px; border-radius:12px; border:1px solid var(--border); font-size: 14px; }
    button, .btn { padding: 10px 14px; border-radius: 12px; border: 1px solid #111; background: #fff; cursor:pointer; font-size: 14px; }
    .btn.primary, button.primary { background:#111; color:#fff; }
    button:disabled { opacity:.45; cursor:not-allowed; }
    h1,h2 { margin: 6px 0 10px; }
    .muted { color: var(--muted); }
    .ok { color: var(--ok); }
    .warn { color: var(--warn); }
    .err { color: var(--err); }
    .center { display:flex; justify-content:center; align-items:center; }
    .hidden { display:none !important; }

    /* Corsi board */
    .board {
      position: relative;
      width: 640px;
      height: 420px;
      max-width: 92vw;
      aspect-ratio: 64/42;
      border: 1px solid var(--border);
      border-radius: 16px;
      margin: 10px auto;
      background: #fff;
      overflow: hidden;
    }
    .block {
      position:absolute;
      width: 78px;
      height: 78px;
      border-radius: 14px;
      border: 2px solid #111;
      background: #f7f7f7;
      box-sizing: border-box;
      display:flex;
      justify-content:center;
      align-items:center;
      user-select:none;
      touch-action: manipulation;
    }
    .block.flash { background:#111; }
    .block.hit { outline: 4px solid #2a7; }
    .block.miss { outline: 4px solid #c33; }

    /* Grid */
    .gridWrap { display:flex; justify-content:center; }
    .grid {
      display:grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 6px;
      width: min(92vw, 720px);
      user-select:none;
    }
    .cell {
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px 0;
      text-align:center;
      font-variant-numeric: tabular-nums;
      background:#fff;
      cursor:pointer;
      touch-action: manipulation;
    }
    .cell.done { background:#eee; color:#999; cursor:default; }
    .cell.bad { outline: 3px solid #c33; }
    .cell.good { outline: 3px solid #2a7; }

    /* TP */
    #tpStim svg { display:block; }
    .bigHint { font-size: 18px; }

    @media (max-width: 760px) {
      .grid { grid-template-columns: repeat(5, 1fr); }
      .cell { padding: 16px 0; font-size: 18px; }
      .block { width: 64px; height: 64px; }
    }
  </style>
</head>
<body>
  <div class="wrap">

    <div class="card">
      <h1>ETO Battery</h1>
      <p class="muted" id="topNotice">
        Please use Chrome on a laptop/tablet if possible.
      </p>
      <p class="muted" id="postStatus"></p>
    </div>

    <!-- Landing (inside battery): ID + consent -->
    <section id="screen-landing" class="card">
      <h2 id="t_landing_title">Welcome</h2>

      <div class="row">
        <label><span id="t_participant">Participant ID</span>:
          <input id="participantId" type="text" placeholder="e.g., P0123" />
        </label>
        <label><span id="t_computer">Computer ID</span>:
          <input id="computerId" type="text" placeholder="e.g., LAB-A-PC1" />
        </label>
        <label><span id="t_language">Language</span>:
          <select id="lang">
            <option value="en">English</option>
            <option value="hu">Magyar</option>
          </select>
        </label>
      </div>

      <div style="margin-top:12px;">
        <label>
          <input id="consent" type="checkbox" />
          <span id="t_consent">I understand and agree to participate.</span>
        </label>
      </div>

      <div class="row" style="margin-top:12px;">
        <button id="btnStart" class="primary" disabled>Start</button>
      </div>

      <p class="muted" id="t_landing_hint" style="margin-top:10px;"></p>
    </section>

    <!-- Corsi -->
    <section id="screen-corsi" class="card hidden">
      <h2 id="t_corsi_title">Corsi Block Tapping</h2>
      <p id="corsiInstr" class="bigHint"></p>

      <div class="row">
        <button id="corsiBegin" class="primary">Begin</button>
        <span class="muted" id="corsiStatus"></span>
      </div>

      <div class="board" id="corsiBoard" aria-label="Corsi board"></div>

      <div class="row" style="margin-top:8px;">
        <button id="corsiNext" class="primary hidden">Next</button>
      </div>
    </section>

    <!-- Grid -->
    <section id="screen-grid" class="card hidden">
      <h2 id="t_grid_title">Number Grid</h2>
      <p id="gridInstr" class="bigHint"></p>

      <div class="row">
        <button id="gridBegin" class="primary">Begin</button>
        <span class="muted" id="gridStatus"></span>
        <span class="muted" id="gridTimer"></span>
      </div>

      <div class="gridWrap">
        <div class="grid" id="grid"></div>
      </div>
    </section>

    <!-- TP Go/No-Go -->
    <section id="screen-tp" class="card hidden">
      <h2 id="t_tp_title">Go/No-Go</h2>
      <p id="t_tp_intro" class="bigHint"></p>

      <div class="row" style="gap:12px; align-items:center; flex-wrap:wrap;">
        <button id="tpStart" class="primary">Start</button>
        <span id="tpStatus" class="muted"></span>
      </div>

      <div id="tpStage" style="margin-top:16px; display:flex; justify-content:center; align-items:center; min-height:260px;">
        <div id="tpStim"></div>
      </div>

      <p class="muted" id="t_tp_hint" style="margin-top:10px;"></p>
      <p class="muted" id="t_tp_resp" style="margin-top:6px;"></p>
    </section>

    <!-- Finish -->
    <section id="screen-finish" class="card hidden">
      <h2 id="t_finish_title">Finished</h2>
      <p id="t_finish_text"></p>

      <div class="row">
        <a id="btnQuestionnaire" class="btn primary" href="#" target="_blank" rel="noopener">Questionnaire</a>
        <button id="btnDownloadCSV">Download CSV backup</button>
      </div>

      <p class="muted" id="t_finish_hint" style="margin-top:10px;"></p>
    </section>

  </div>

<script>
/* =======================
   CONFIG — EDIT THESE
======================= */

// Paste your Apps Script Web App URL here (the one ending with /exec).
// Example: https://script.google.com/macros/s/XXXXX/exec

// BATTERY VERSION MARKER (remove if you want)
  console.log("BATTERY VERSION: 2026-01-10 14:06");

const SHEETS_WEBAPP_URL = "https://script.google.com/macros/s/AKfycbw3ZQ1bLj9EG6GD4MPpLLzQ1sTIU9OjBazJfG2tKTxyT1KyElmjEca36IF4fdZpo5nxwg/exec";

// Questionnaire links
const FORM_HU = "https://docs.google.com/forms/d/1KcXUHSDgzjEB64LFnpXH0Sa0tG4YSoG-39E_2RHor40/";
const FORM_EN = "https://docs.google.com/forms/d/1NENoY5RpnPbr3fnxPKTN-5R4UpdWPpwg_IcsJ6aap24/";

// Measurement wave label
const TRIAL_WAVE = "T2";

/* =======================
   HELPERS + I18N
======================= */
const $ = id => document.getElementById(id);
const sleep = ms => new Promise(r => setTimeout(r, ms));
const fmt2 = n => (n < 10 ? '0'+n : ''+n);

const I18N = {
  en: {
    topNotice: "Please use Chrome on a laptop/tablet if possible.",
    landing_title: "Welcome",
    participant: "Participant ID",
    computer: "Computer ID",
    language: "Language",
    consent: "I understand and agree to participate.",
    landing_hint: "You will complete 3 tasks: Corsi → Number Grid → Go/No-Go. Then open the questionnaire.",
    start: "Start",

    corsi_title: "Corsi Block Tapping",
    corsi_instr: "Watch the blocks light up, then click the same sequence in the same order.",
    corsi_begin: "Begin",
    corsi_next: "Next",
    corsi_showing: "Showing sequence…",
    corsi_yourturn: "Your turn.",
    corsi_correct: "Correct.",
    corsi_wrong: "Wrong.",
    corsi_done: "Corsi finished.",

    grid_title: "Number Grid (00–99)",
    grid_instr: "Click numbers in ascending order: 00, 01, 02 … as fast and accurately as possible. You have 4 minutes.",
    grid_begin: "Begin",
    grid_running: "Running…",
    grid_done: "Grid finished.",

    tp_title: "Go/No-Go (Attention & Inhibition)",
    tp_intro: "Symbols appear one by one for 5 minutes. Press SPACE (or tap/click the symbol) ONLY when the symbol is a target. Do NOT respond to non-targets.",
    tp_hint: "Targets are the 4 corner-type symbols (NE, NW, SE, SW).",
    tp_resp: "Response: SPACE key or click/tap the symbol.",
    tp_start: "Start",
    tp_running: "Running…",
    tp_done: "Done.",

    finish_title: "Finished",
    finish_text: "Thank you! Please open and complete the questionnaire.",
    finish_hint: "If the questionnaire is already completed, you may close this tab.",
    questionnaire: "Questionnaire",

    posting: "Saving data to Google Sheets…",
    posted: "Data sent to Google Sheets.",
    posterr: "Could not confirm sending (this can be normal). CSV backup is available below."
  },
  hu: {
    topNotice: "Lehetőleg Chrome böngészőben, laptopon/tableten töltsd ki.",
    landing_title: "Üdvözlünk",
    participant: "Résztvevő azonosító",
    computer: "Gép azonosító",
    language: "Nyelv",
    consent: "Megértettem és hozzájárulok a részvételhez.",
    landing_hint: "3 feladat következik: Corsi → Számrács → Go/No-Go. Ezután nyisd meg a kérdőívet.",
    start: "Indítás",

    corsi_title: "Corsi blokk-koppintás",
    corsi_instr: "Figyeld a felvillanó blokkokat, majd kattints ugyanarra a sorrendre ugyanabban a sorrendben.",
    corsi_begin: "Kezdés",
    corsi_next: "Tovább",
    corsi_showing: "Sorrend bemutatása…",
    corsi_yourturn: "Te jössz.",
    corsi_correct: "Helyes.",
    corsi_wrong: "Hibás.",
    corsi_done: "Corsi kész.",

    grid_title: "Számrács (00–99)",
    grid_instr: "Kattints növekvő sorrendben: 00, 01, 02 … minél gyorsabban és pontosabban. 4 perced van.",
    grid_begin: "Kezdés",
    grid_running: "Fut…",
    grid_done: "Számrács kész.",

    tp_title: "Go/No-Go (Figyelem és gátlás)",
    tp_intro: "Szimbólumok jelennek meg egymás után 5 percig. Csak a célingereknél nyomj SPACE-t (vagy kattints/tapints). A többi esetben NE reagálj.",
    tp_hint: "Célingerek: a 4 „sarok” jellegű szimbólum (NE, NW, SE, SW).",
    tp_resp: "Válasz: SPACE billentyű vagy kattintás/tapintás a szimbólumon.",
    tp_start: "Indítás",
    tp_running: "Fut…",
    tp_done: "Kész.",

    finish_title: "Befejezve",
    finish_text: "Köszönjük! Kérlek, nyisd meg és töltsd ki a kérdőívet.",
    finish_hint: "Ha már kitöltötted a kérdőívet, bezárhatod ezt a lapot.",
    questionnaire: "Kérdőív",

    posting: "Adatok mentése a Google Sheets-be…",
    posted: "Adatok elküldve a Google Sheets-be.",
    posterr: "Nem sikerült visszaigazolni az elküldést (ez néha normális). CSV biztonsági mentés elérhető."
  }
};

// language selection carry-over from landing page (index.html)
const SAVED_LANG_RAW = localStorage.getItem("ETO_LANG") || "en";
let lang = (SAVED_LANG_RAW === "hu" || SAVED_LANG_RAW === "en") ? SAVED_LANG_RAW : "en";
let T = I18N[lang] || I18N.en;

// global state
let sessionId = null;
let allRows = []; // every click/trial from every task

function setLang(newLang) {
  lang = (newLang === "hu" || newLang === "en") ? newLang : "en";
  T = I18N[lang] || I18N.en;

  document.documentElement.lang = lang;
  $("topNotice").textContent = T.topNotice;

  // landing labels
  $("t_landing_title").textContent = T.landing_title;
  $("t_participant").textContent = T.participant;
  $("t_computer").textContent = T.computer;
  $("t_language").textContent = T.language;
  $("t_consent").textContent = T.consent;
  $("t_landing_hint").textContent = T.landing_hint;
  $("btnStart").textContent = T.start;

  // Corsi
  $("t_corsi_title").textContent = T.corsi_title;
  $("corsiInstr").textContent = T.corsi_instr;
  $("corsiBegin").textContent = T.corsi_begin;
  $("corsiNext").textContent = T.corsi_next;

  // Grid
  $("t_grid_title").textContent = T.grid_title;
  $("gridInstr").textContent = T.grid_instr;
  $("gridBegin").textContent = T.grid_begin;

  // TP
  $("t_tp_title").textContent = T.tp_title;
  $("t_tp_intro").textContent = T.tp_intro;
  $("t_tp_hint").textContent  = T.tp_hint;
  $("t_tp_resp").textContent  = T.tp_resp;
  $("tpStart").textContent    = T.tp_start;

  // Finish
  $("t_finish_title").textContent = T.finish_title;
  $("t_finish_text").textContent = T.finish_text;
  $("t_finish_hint").textContent = T.finish_hint;
  $("btnQuestionnaire").textContent = T.questionnaire;

  // sync selector
  const sel = $("lang");
  if (sel) sel.value = lang;

  // also store for future visits
  localStorage.setItem("ETO_LANG", lang);
}

// apply initial language now (function exists)
setLang(lang);

// ====== UI helpers ======
function show(id) { $(id).classList.remove("hidden"); }
function hide(id) { $(id).classList.add("hidden"); }
function onlyShow(screenId) {
  ["screen-landing","screen-corsi","screen-grid","screen-tp","screen-finish"].forEach(s => hide(s));
  show(screenId);
}

function makeSessionId() {
  // stable enough unique id: timestamp + random
  return `${Date.now()}-${Math.floor(Math.random()*1e9)}`;
}

function validateLanding() {
  const pid = $("participantId").value.trim();
  const cid = $("computerId").value.trim();
  const ok = pid.length >= 2 && cid.length >= 2 && $("consent").checked;
  $("btnStart").disabled = !ok;
}

// ====== Logging ======
function baseRow(taskname) {
  return {
    timestamp: new Date().toISOString(),
    lang: lang,
    participantId: $("participantId").value.trim(),
    computerId: $("computerId").value.trim(),
    span: "",
    sequence: "",
    response: "",
    correct: "",
    firstRT_ms: "",
    allRTs_ms: "",
    interClickRTs_ms: "",
    totalTime_ms: "",
    sessionId: sessionId,
    taskname: taskname,
    trialIndex: "",
    targetNumber: "",
    clickedNumber: "",
    rtSincePrevCorrect_ms: "",
    absoluteTime_ms: Date.now(),
    trialWave: TRIAL_WAVE
  };
}

/* =======================
   CORSI TASK
======================= */
const corsiPositionsPct = [
  { left:  8, top:  8 },
  { left: 42, top:  6 },
  { left: 74, top: 10 },
  { left: 22, top: 34 },
  { left: 52, top: 34 },
  { left:  8, top: 60 },
  { left: 36, top: 56 },
  { left: 70, top: 56 },
  { left: 52, top: 78 }
];

let corsiBlocks = [];
let corsiSpan = 2;
let corsiTrialIndex = 0;
let corsiSeq = [];
let corsiClicks = [];
let corsiFirstRT = null;
let corsiClickTimes = []; // absolute performance.now times
let corsiTrialStart = 0;
let corsiErrorsAtSpan = 0;
const CORSI_FLASH_MS = 600;
const CORSI_GAP_MS = 250;

function corsiBuildBoard() {
  const board = $("corsiBoard");
  board.innerHTML = "";
  corsiBlocks = [];

  for (let i=0;i<9;i++){
    const d = document.createElement("div");
    d.className = "block";
    d.style.left = corsiPositionsPct[i].left + "%";
    d.style.top  = corsiPositionsPct[i].top  + "%";
    d.dataset.index = String(i);
    d.addEventListener("click", () => corsiHandleClick(i, d));
    board.appendChild(d);
    corsiBlocks.push(d);
  }
}

function corsiMakeSequence(span) {
  const seq = [];
  while (seq.length < span) {
    const n = Math.floor(Math.random()*9);
    if (seq.length === 0 || seq[seq.length-1] !== n) seq.push(n);
  }
  return seq;
}

async function corsiShowSequence(seq) {
  $("corsiStatus").textContent = T.corsi_showing;
  for (const idx of seq) {
    const b = corsiBlocks[idx];
    b.classList.add("flash");
    await sleep(CORSI_FLASH_MS);
    b.classList.remove("flash");
    await sleep(CORSI_GAP_MS);
  }
  $("corsiStatus").textContent = T.corsi_yourturn;
}

function corsiStartTrial() {
  corsiTrialIndex++;
  corsiSeq = corsiMakeSequence(corsiSpan);
  corsiClicks = [];
  corsiFirstRT = null;
  corsiClickTimes = [];
  corsiTrialStart = performance.now();

  corsiBlocks.forEach(b => { b.classList.remove("hit","miss"); });
  $("corsiNext").classList.add("hidden");

  corsiShowSequence(corsiSeq);
}

function corsiHandleClick(idx, el) {
  // ignore clicks while showing sequence (simple heuristic: require status "Your turn")
  if ($("corsiStatus").textContent === T.corsi_showing) return;

  const now = performance.now();
  if (corsiClicks.length === 0) corsiFirstRT = Math.round(now - corsiTrialStart);

  corsiClicks.push(idx);
  corsiClickTimes.push(now);

  // feedback outline
  const expected = corsiSeq[corsiClicks.length-1];
  if (idx === expected) el.classList.add("hit");
  else el.classList.add("miss");

  if (corsiClicks.length === corsiSeq.length) corsiEvaluateTrial();
}

function corsiEvaluateTrial() {
  const correct = corsiClicks.length === corsiSeq.length &&
                  corsiClicks.every((v,i) => v === corsiSeq[i]);

  const totalTime = Math.round(performance.now() - corsiTrialStart);

  // allRTs: time since trial start at each click
  const allRTs = corsiClickTimes.map(t => Math.round(t - corsiTrialStart)).join(";");

  // interClick RTs: first is firstRT, then diffs
  const inter = corsiClickTimes.map((t,i) => i===0 ? Math.round(t - corsiTrialStart)
                                                   : Math.round(t - corsiClickTimes[i-1])).join(";");

  // Log one row per Corsi trial (not per click)
  const row = baseRow("Corsi");
  row.span = corsiSpan;
  row.sequence = corsiSeq.map(x => x+1).join("-"); // 1..9 for readability
  row.response = corsiClicks.map(x => x+1).join("-");
  row.correct = correct ? 1 : 0;
  row.firstRT_ms = corsiFirstRT == null ? "" : corsiFirstRT;
  row.allRTs_ms = allRTs;
  row.interClickRTs_ms = inter;
  row.totalTime_ms = totalTime;
  row.trialIndex = corsiTrialIndex;

  allRows.push(row);

  $("corsiStatus").textContent = correct ? T.corsi_correct : T.corsi_wrong;

  if (correct) {
    corsiSpan += 1;
    corsiErrorsAtSpan = 0;
  } else {
    corsiErrorsAtSpan += 1;
  }

  // stopping rule: two errors at same span OR span > 9
  const done = corsiErrorsAtSpan >= 2 || corsiSpan > 9;

  if (done) {
    $("corsiStatus").textContent = T.corsi_done;
    $("corsiNext").classList.remove("hidden");
    $("corsiNext").textContent = T.corsi_next;
  } else {
    $("corsiNext").classList.remove("hidden");
    $("corsiNext").textContent = T.corsi_next;
  }
}

/* =======================
   GRID TASK (00-99)
======================= */
const GRID_LIMIT_MS = 4 * 60 * 1000; // 4 minutes
let gridNumbers = [];
let gridExpected = 0;
let gridStarted = false;
let gridStartPerf = 0;
let gridLastCorrectPerf = 0;
let gridClickIndex = 0;
let gridTimerHandle = null;

function gridBuild() {
  const el = $("grid");
  el.innerHTML = "";
  gridNumbers = Array.from({length:100}, (_,i)=>i);
  // shuffle
  for (let i=gridNumbers.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [gridNumbers[i], gridNumbers[j]] = [gridNumbers[j], gridNumbers[i]];
  }
  gridNumbers.forEach((n, pos) => {
    const cell = document.createElement("div");
    cell.className = "cell";
    cell.textContent = fmt2(n);
    cell.dataset.num = String(n);
    cell.addEventListener("click", () => gridHandleClick(n, cell));
    el.appendChild(cell);
  });
}

function gridStart() {
  gridBuild();
  gridExpected = 0;
  gridStarted = true;
  gridStartPerf = performance.now();
  gridLastCorrectPerf = gridStartPerf;
  gridClickIndex = 0;
  $("gridStatus").textContent = T.grid_running;
  $("gridBegin").disabled = true;

  // timer
  if (gridTimerHandle) clearInterval(gridTimerHandle);
  gridTimerHandle = setInterval(() => {
    const elapsed = performance.now() - gridStartPerf;
    const left = Math.max(0, GRID_LIMIT_MS - elapsed);
    const sec = Math.ceil(left/1000);
    $("gridTimer").textContent = `⏱ ${sec}s`;
    if (left <= 0) gridEnd();
  }, 200);
}

function gridHandleClick(n, cell) {
  if (!gridStarted) return;
  const now = performance.now();
  const expected = gridExpected;

  let correct = 0;
  if (n === expected) {
    correct = 1;
    cell.classList.add("done");
    cell.classList.remove("bad");
    cell.classList.add("good");
    gridExpected += 1;
    gridLastCorrectPerf = now;
  } else {
    cell.classList.add("bad");
    setTimeout(()=>cell.classList.remove("bad"), 250);
  }

  const rtSincePrev = Math.round(now - gridLastCorrectPerf); // if correct, this is ~0; so compute carefully
  // better: RT since previous correct is time between correct clicks; for incorrect clicks, we still log since last correct.
  const rtPrev = Math.round(now - (correct ? (now) : gridLastCorrectPerf));
  // We'll log rtSincePrevCorrect_ms as time since last correct BEFORE this click.
  const rtSincePrevCorrect = Math.round(now - (correct ? (now) : gridLastCorrectPerf));

  // Correct measure: time since last correct *before* evaluating. Let's compute properly:
  // Use a stored variable oldLastCorrectPerf before possible update.
}

function gridHandleClick(n, cell) {
  if (!gridStarted) return;

  const now = performance.now();
  const expected = gridExpected;
  const prevCorrectTime = gridLastCorrectPerf;

  let correct = 0;
  if (n === expected) {
    correct = 1;
    cell.classList.add("done");
    cell.classList.remove("bad");
    cell.classList.add("good");
    gridExpected += 1;
    gridLastCorrectPerf = now;
  } else {
    cell.classList.add("bad");
    setTimeout(()=>cell.classList.remove("bad"), 250);
  }

  gridClickIndex += 1;

  const rtSincePrevCorrect = Math.round(now - prevCorrectTime);
  const totalElapsed = Math.round(now - gridStartPerf);

  const row = baseRow("Grid");
  row.trialIndex = gridClickIndex;
  row.targetNumber = fmt2(expected);
  row.clickedNumber = fmt2(n);
  row.correct = correct;
  row.firstRT_ms = "";           // not used for grid
  row.rtSincePrevCorrect_ms = rtSincePrevCorrect;
  row.totalTime_ms = totalElapsed; // cumulative from grid start
  // keep sequence/response empty
  allRows.push(row);

  // stop if completed all numbers
  if (gridExpected >= 100) gridEnd();
}

function gridEnd() {
  if (!gridStarted) return;
  gridStarted = false;
  $("gridStatus").textContent = T.grid_done;
  $("gridBegin").disabled = true;
  if (gridTimerHandle) clearInterval(gridTimerHandle);
  $("gridTimer").textContent = "";

  // Proceed to TP screen
  onlyShow("screen-tp");
  tpInitScreen();
}

/* =======================
   TP SYMBOLS + TASK
======================= */
function tickKey(ticks) { return ticks.slice().sort().join(""); }

function makeTPSymbolSVG(ticks, size=140, stroke=6, tickLen=18) {
  const pad = 18;
  const x0 = pad, y0 = pad;
  const x1 = size - pad, y1 = size - pad;
  const midX = (x0 + x1) / 2;
  const midY = (y0 + y1) / 2;

  const lines = [];
  ticks.forEach(t => {
    if (t === "N") lines.push([midX, y0, midX, y0 - tickLen]);
    if (t === "S") lines.push([midX, y1, midX, y1 + tickLen]);
    if (t === "W") lines.push([x0, midY, x0 - tickLen, midY]);
    if (t === "E") lines.push([x1, midY, x1 + tickLen, midY]);
  });

  const tickLines = lines.map(([xA,yA,xB,yB]) =>
    `<line x1="${xA}" y1="${yA}" x2="${xB}" y2="${yB}" />`
  ).join("");

  return `
    <svg width="${size}" height="${size}" viewBox="0 0 ${size} ${size}" aria-hidden="true">
      <g fill="none" stroke="black" stroke-width="${stroke}" stroke-linecap="round">
        <rect x="${x0}" y="${y0}" width="${x1-x0}" height="${y1-y0}" rx="6" ry="6"></rect>
        ${tickLines}
      </g>
    </svg>
  `;
}

const TP_GO_TARGETS = [
  ["N","E"], ["N","W"], ["S","E"], ["S","W"]
].map(t => ({ ticks: t, key: tickKey(t) }));
const TP_GO_KEYS = new Set(TP_GO_TARGETS.map(x => x.key));

const TP_NOGO_POOL = (function buildNoGoPool(){
  const edges = ["N","E","S","W"];
  const pool = [];

  edges.forEach(e => pool.push({ ticks:[e], key: tickKey([e]) }));
  [["N","E","S"], ["N","E","W"], ["N","S","W"], ["E","S","W"]].forEach(t => pool.push({ ticks:t, key: tickKey(t) }));

  for (let i=0;i<edges.length;i++){
    for (let j=i+1;j<edges.length;j++){
      const ticks = [edges[i], edges[j]];
      const key = tickKey(ticks);
      if (!TP_GO_KEYS.has(key)) pool.push({ ticks, key });
    }
  }
  return pool;
})();

const TP_SOA_MS = 1000;
const TP_TOTAL_TRIALS = 300;
const TP_GO_RATIO = 0.75;

let tpTrials = [];
let tpIdx = 0;
let tpRunning = false;
let tpTrialStartPerf = 0;
let tpResponded = false;
let tpRT = null;

function tpBuildTrials() {
  const nGo = Math.round(TP_TOTAL_TRIALS * TP_GO_RATIO);
  const nNoGo = TP_TOTAL_TRIALS - nGo;
  const trials = [];

  for (let i=0;i<nGo;i++){
    const s = TP_GO_TARGETS[Math.floor(Math.random()*TP_GO_TARGETS.length)];
    trials.push({ stimType:"GO", stimKey:s.key, ticks:s.ticks });
  }
  for (let i=0;i<nNoGo;i++){
    const s = TP_NOGO_POOL[Math.floor(Math.random()*TP_NOGO_POOL.length)];
    trials.push({ stimType:"NOGO", stimKey:s.key, ticks:s.ticks });
  }

  for (let i=trials.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [trials[i], trials[j]] = [trials[j], trials[i]];
  }
  return trials;
}

function tpInitScreen() {
  $("tpStatus").textContent = "";
  $("tpStim").innerHTML = "";
  $("tpStart").disabled = false;
}

function tpRegisterResponse() {
  if (!tpRunning) return;
  if (tpResponded) return;
  tpResponded = true;
  tpRT = Math.round(performance.now() - tpTrialStartPerf);
}

function tpPresentTrial() {
  if (!tpRunning) return;

  if (tpIdx >= tpTrials.length) {
    tpEndTask();
    return;
  }

  const tr = tpTrials[tpIdx];
  $("tpStim").innerHTML = makeTPSymbolSVG(tr.ticks);

  tpResponded = false;
  tpRT = null;
  tpTrialStartPerf = performance.now();

  setTimeout(tpFinalizeTrial, TP_SOA_MS);
}

function tpFinalizeTrial() {
  if (!tpRunning) return;

  const tr = tpTrials[tpIdx];
  const responded = tpResponde? 1 : 0; // safeguard typo? We'll correct below.
}

function tpFinalizeTrial() {
  if (!tpRunning) return;

  const tr = tpTrials[tpIdx];
  const responded = tpResponded ? 1 : 0;
  const rt = tpRT; // null if no response

  let correct = 0;
  if (tr.stimType === "GO") correct = responded ? 1 : 0;
  else correct = responded ? 0 : 1;

  const row = baseRow("TP_GONOGO");
  row.trialIndex = tpIdx + 1;
  row.sequence = tr.stimKey;
  row.targetNumber = tr.stimType;
  row.clickedNumber = responded;
  row.response = responded ? "press" : "none";
  row.correct = correct;
  row.firstRT_ms = (rt == null ? "" : rt);
  row.totalTime_ms = TP_SOA_MS;
  row.rtSincePrevCorrect_ms = (rt == null ? "" : rt);

  allRows.push(row);

  tpIdx++;
  tpPresentTrial();
}

function tpStartTask() {
  tpTrials = tpBuildTrials();
  tpIdx = 0;
  tpRunning = true;
  $("tpStatus").textContent = T.tp_running;
  $("tpStart").disabled = true;
  tpPresentTrial();
}

function tpEndTask() {
  tpRunning = false;
  $("tpStatus").textContent = T.tp_done;
  $("tpStim").innerHTML = "";

  // proceed to finish + post
  endBattery();
}

/* =======================
   POSTING + FINISH
======================= */
function toCSV(rows) {
  // ensure stable header order
  const header = [
    "timestamp","lang","participantId","computerId","span","sequence","response","correct",
    "firstRT_ms","allRTs_ms","interClickRTs_ms","totalTime_ms","sessionId","taskname","trialIndex",
    "targetNumber","clickedNumber","rtSincePrevCorrect_ms","absoluteTime_ms","trialWave"
  ];
  const esc = v => {
    if (v == null) return "";
    const s = String(v);
    if (/[",\n\r]/.test(s)) return '"' + s.replace(/"/g,'""') + '"';
    return s;
  };
  const lines = [header.join(",")];
  for (const r of rows) {
    lines.push(header.map(k => esc(r[k])).join(","));
  }
  return lines.join("\n");
}

async function postRowsToSheets(rows) {
  if (!SHEETS_WEBAPP_URL || SHEETS_WEBAPP_URL.startsWith("PASTE_")) return;

  $("postStatus").textContent = T.posting;
  $("postStatus").className = "muted warn";

  // Send as text/plain to avoid CORS preflight; Apps Script can parse JSON from contents.
  const payload = JSON.stringify({ rows });
  try {
    await fetch(SHEETS_WEBAPP_URL, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain;charset=utf-8" },
      body: payload
    });
    $("postStatus").textContent = T.posted;
    $("postStatus").className = "muted ok";
  } catch (e) {
    console.warn("Sheets post failed:", e);
    $("postStatus").textContent = T.posterr;
    $("postStatus").className = "muted err";
  }
}

function downloadCSVBackup() {
  const csv = toCSV(allRows);
  const blob = new Blob([csv], { type: "text/csv;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  a.href = url;
  a.download = `ETO_Battery_${$("participantId").value.trim()}_${TRIAL_WAVE}.csv`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=>URL.revokeObjectURL(url), 1000);
}

async function endBattery() {
  // post to Sheets
  await postRowsToSheets(allRows);

  // setup questionnaire button
  $("btnQuestionnaire").href = (lang === "hu") ? FORM_HU : FORM_EN;

  onlyShow("screen-finish");
}

function startBattery() {
  sessionId = makeSessionId();
  allRows = [];

  // save lang to localStorage (so landing choice persists)
  localStorage.setItem("ETO_LANG", lang);

  corsiBuildBoard();
  onlyShow("screen-corsi");
  $("corsiStatus").textContent = "";
  $("corsiBegin").disabled = false;
  $("corsiNext").classList.add("hidden");
}

function init() {
  // sync dropdown + event
  $("lang").addEventListener("change", e => setLang(e.target.value));

  $("participantId").addEventListener("input", validateLanding);
  $("computerId").addEventListener("input", validateLanding);
  $("consent").addEventListener("change", validateLanding);

  $("btnStart").addEventListener("click", startBattery);

  // Corsi buttons
  $("corsiBegin").addEventListener("click", () => {
    $("corsiBegin").disabled = true;
    corsiSpan = 2;
    corsiTrialIndex = 0;
    corsiErrorsAtSpan = 0;
    corsiStartTrial();
  });
  $("corsiNext").addEventListener("click", () => {
    // if done, go next; otherwise next trial
    if ($("corsiStatus").textContent === T.corsi_done) {
      onlyShow("screen-grid");
      $("gridBegin").disabled = false;
      $("gridStatus").textContent = "";
      $("gridTimer").textContent = "";
    } else {
      corsiStartTrial();
    }
  });

  // Grid begin
  $("gridBegin").addEventListener("click", gridStart);

  // TP handlers
  $("tpStart").addEventListener("click", tpStartTask);
  $("tpStim").addEventListener("click", tpRegisterResponse);
  window.addEventListener("keydown", (e) => {
    if (e.code === "Space") {
      e.preventDefault();
      tpRegisterResponse();
    }
  });

  // Finish backup download
  $("btnDownloadCSV").addEventListener("click", downloadCSVBackup);

  // prefill language from landing choice
  const saved = localStorage.getItem("ETO_LANG");
  if (saved === "hu" || saved === "en") setLang(saved);

  validateLanding();
}

init();
</script>
</body>
</html>
